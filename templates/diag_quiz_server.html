{% extends "base.html" %}

{% block conteudo %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="section-title text-info" style="border-color: #0dcaf0 !important;">
            <i class="bi bi-patch-check-fill"></i> Avaliação Técnica (Processado por Python)
        </h2>
        <p class="text-muted">Este quiz é corrigido no servidor. Responda com atenção.</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 mx-auto">
        {% if resultados %}
            {% set aprovado = porcentagem >= 70 %}
            {% set nome_modulo = modulo.upper() %}
            
            <div class="alert alert-dismissible fade show p-4 shadow-lg mb-5 {{ 'alert-success' if aprovado else 'alert-danger' }}" role="alert">
                <h3 class="fw-bold"><i class="bi {{ 'bi-check-circle-fill' if aprovado else 'bi-x-octagon-fill' }} me-2"></i> RESULTADO DO MÓDULO {{ nome_modulo }}</h3>
                <hr>
                <h1 class="display-3">{{ pontuacao }}/{{ total }}</h1>
                <p class="fs-4 fw-bold">Aproveitamento: {{ "%0.0f"|format(porcentagem) }}%</p>
                <p class="small">{{ 'Parabéns! Nível de conhecimento profissional atingido.' if aprovado else 'Abaixo de 70%. Revise o material e tente novamente.' }}</p>
                <a href="{{ url_for('diag_quiz', modulo=modulo) }}" class="btn btn-secondary mt-3 fw-bold">Refazer o Teste (Novas Questões)</a>
                <a href="/diag" class="btn btn-info mt-3 fw-bold">Voltar para Central de Diagnóstico</a>
            </div>

        {% else %}
            <form method="POST" action="{{ url_for('diag_quiz') }}" class="mb-5">
                <h4 class="text-center text-info fw-bold mb-4">Teste de Proficiência {{ modulo.upper() }}</h4>
                
                <input type="hidden" name="modulo" value="{{ modulo }}">

                {% for key, item in quiz.items() %}
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <p class="fw-bold fs-5">{{ loop.index }}. {{ item.pergunta }}</p>
                        
                        {% for op_key, op_value in item.opcoes.items() %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="{{ key }}" id="{{ key }}_{{ op_key }}" value="{{ op_key }}" required>
                            <label class="form-check-label" for="{{ key }}_{{ op_key }}">
                                {{ op_value }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}

                <div class="d-grid mt-5">
                    <button type="submit" class="btn btn-info btn-lg fw-bold text-white">
                        <i class="bi bi-check-circle-fill"></i> FINALIZAR E CORRIGIR (Servidor)
                    </button>
                </div>
            </form>
            
        {% endif %}

        {% if resultados %}
        <h3 class="section-title text-danger mt-5"><i class="bi bi-x-circle"></i> Detalhe da Correção</h3>
        
        {% for key, resultado in resultados.items() %}
        {% set pergunta = quiz[key] %}
        
        <div class="card mb-3 shadow-sm border-{{ 'success' if resultado.correta else 'danger' }}">
            <div class="card-body">
                <p class="fw-bold text-dark mb-2">{{ loop.index }}. {{ pergunta.pergunta }}</p>
                <p class="mb-1">Sua Resposta: 
                    <strong class="{{ 'text-success' if resultado.correta else 'text-danger' }}">
                        {{ pergunta.opcoes[resultado.dada] if resultado.dada else '[NÃO RESPONDIDO]' }}
                    </strong>
                </p>
                {% if not resultado.correta %}
                <p class="mb-0 text-muted small">Resposta Correta: 
                    <span class="text-success fw-bold">{{ pergunta.opcoes[pergunta.resposta] }}</span>
                </p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>
</div>
{% endblock %}
